* 2026.01.09 20:39:03

# Дополнение к ТЗ АС «pro_ai_agents»: Модель данных (MVP)

**Дата:** 2026-01-09  
**Статус:** утверждено  
**Относится к ТЗ.md:** разделы 11, 13  

---

## 1 Назначение дополнения

Настоящее дополнение:
- фиксирует **минимальную логическую модель данных MVP**;
- определяет **enum, индексы и ограничения целостности**;
- служит основанием для реализации хранилища PostgreSQL.

---

## 2 Общие принципы модели данных

- Модель ориентирована на **аудит, воспроизводимость и дедупликацию**.
- Все ключевые сущности имеют:
  - технический `id` (UUID);
  - временные поля (`created_at`, при необходимости `updated_at`);
  - неизменяемые ссылки на первоисточник.
- Историчность сохраняется через новые записи, а не перезапись.

---

## 3 Перечень сущностей (MVP)

### 3.1 Source
Источник информации.

**Поля:**
- `id`
- `name`
- `source_type` (enum, см. 4.1)
- `trust_level` (int, 1..5)
- `base_url`
- `is_enabled` (bool)
- `created_at`

**Ограничения:**
- `unique(base_url)`

---

### 3.2 SourceItem
Конкретный материал источника.

**Поля:**
- `id`
- `source_id` (FK → Source)
- `canonical_url`
- `title`
- `published_at`
- `fetched_at`
- `raw_storage_key`
- `raw_hash`
- `text_hash`

**Ограничения:**
- `unique(canonical_url)`

**Индексы:**
- `(source_id, published_at)`
- `(raw_hash)`
- `(text_hash)`

---

### 3.3 Candidate
Кандидат на генерацию контента.

**Поля:**
- `id`
- `source_item_id` (FK → SourceItem)
- `content_type` (enum, см. 4.2)
- `status` (enum, см. 4.3)
- `score` (numeric, optional)
- `created_at`

**Индексы:**
- `(content_type, status)`
- `(created_at)`

---

### 3.4 Draft
Сгенерированный черновик.

**Поля:**
- `id`
- `candidate_id` (FK → Candidate)
- `template_name` (enum, см. 4.4)
- `title`
- `datetime`
- `summary` (nullable)
- `body`
- `period` (nullable)
- `sources_json`
- `tags_json`
- `llm_provider`
- `llm_model`
- `llm_cost`
- `created_at`

**Индексы:**
- `(candidate_id)`
- `(created_at)`

---

### 3.5 ModerationDecision
Решение модерации.

**Поля:**
- `id`
- `draft_id` (FK → Draft)
- `decision` (enum, см. 4.5)
- `reject_reason` (enum, nullable, см. 4.6)
- `decided_by`
- `decided_at`
- `note` (nullable)

**Ограничения:**
- `unique(draft_id)`

---

### 3.6 Publication
Факт публикации.

**Поля:**
- `id`
- `draft_id` (FK → Draft)
- `tg_channel_name`
- `tg_message_id`
- `published_at`
- `edited_at` (nullable)

**Ограничения:**
- `unique(draft_id)`
- `unique(tg_channel_name, tg_message_id)`

---

## 4 Перечень enum (MVP)

### 4.1 SourceType
`rss | github | docs | specification | standard | blog | media | preprint | search`

---

### 4.2 ContentType
`News | Insight | Report`

---

### 4.3 CandidateStatus
`Queued | Drafted | Rejected | Published`

---

### 4.4 TemplateName
`template_content_tg_news | template_content_tg_insight | template_content_tg_report`

---

### 4.5 ModerationDecisionType
`Approve | Reject | Edit`

---

### 4.6 RejectReason
`Duplicate | NoPrimarySource | OffTopic | FactRisk | StyleViolation | ComplianceRisk`

---

## 5 Правила целостности и потока данных

- Для одного `SourceItem` допускается **несколько Candidate** (разные ContentType).
- Для одного `Candidate` допускается **один Draft**.
- Для одного `Draft` допускается **одно ModerationDecision**.
- Публикация (`Publication`) возможна **только при наличии решения Approve**.
- Повторная публикация при совпадении `SourceItem.canonical_url` запрещена (дедуп на уровне SourceItem).

---

## 6 Минимальные требования к отчётности (поддержка метрик)

Данные модели обеспечивают расчёт:
- PublishCount
- RejectRate
- RejectReasonTop
- CycleTimeMinutes
- LLMCostPerPost

Без введения дополнительных таблиц.

---

## 7 Ограничения и примечания

- История изменений текста Draft не хранится (MVP).
- Версионирование схемы БД осуществляется миграциями.
- Расширение модели (series, cross-links, storytelling) оформляется отдельным дополнением.

---