* 2026.01.09 20:27:01

# Дополнение к ТЗ АС «pro_ai_agents»: LLM-промпты и контракты генерации

**Дата:** 2026-01-09  
**Статус:** утверждено  
**Относится к ТЗ.md:** разделы 10, 12  

---

## 1 Назначение дополнения

Настоящее дополнение:
- фиксирует **набор LLM-шагов** и их назначение в контент-конвейере;
- определяет **строгие JSON-контракты** для каждого шага;
- задаёт **принципы построения системных промптов** без привязки к конкретному провайдеру.

Дополнение **не описывает стиль, источниковедение и фактчекинг** — они заданы в ТЗ.md и анализе предметной области.

---

## 2 Общие принципы работы с LLM

- Каждый вызов LLM:
  - выполняет **одну логически завершённую задачу**;
  - возвращает **только JSON**, без поясняющего текста;
  - не содержит инструкций, противоречащих ТЗ и утверждённым политикам.
- Вся проверка корректности выполняется **до публикации**, на этапе валидации.
- Любая генерация без прохождения валидации считается недопустимой.

---

## 3 Последовательность LLM-шагов (MVP)

1. **ExtractFactsJson** — извлечение фактов из первоисточника.  
2. **GenerateDraftJson** — генерация черновика по шаблону.  
3. **ValidateDraftJson** — автоматическая проверка формата и рисков.  
4. **RenderText** — финальный рендер текста для Telegram.

Шаги выполняются строго последовательно.

---

## 4 Контракт ExtractFactsJson

### Назначение
Извлечь проверяемые факты из первоисточника без интерпретаций и выводов.

### Выходной JSON
```json
{
  "canonical_url": "string",
  "title": "string",
  "published_at": "datetime|null",
  "facts": [
    {
      "claim": "string",
      "evidence_url": "string",
      "evidence_quote": "string|null"
    }
  ],
  "entities": [
    {
      "name": "string",
      "type": "org|product|protocol|person|other"
    }
  ],
  "tags": ["string"]
}
````

### Правила

* `facts.claim` — только утверждения, подтверждённые источником.
* Запрещены выводы, сравнения, прогнозы.
* `canonical_url` должен соответствовать нормализации, заданной в ТЗ.md.

---

## 5 Контракт GenerateDraftJson

### Назначение

Сформировать черновик публикации строго по утверждённому шаблону.

### Выходной JSON

```json
{
  "template_name": "template_content_tg_news | template_content_tg_insight | template_content_tg_report",
  "Title": "string",
  "Datetime": "datetime",
  "Summary": "string|null",
  "Body": "string",
  "Period": "datetime-datetime|null",
  "Sources": ["string"],
  "Tags": ["string"]
}
```

### Правила

* Используется **только информация**, полученная на шаге ExtractFactsJson.
* Структура текста должна соответствовать типу контента:
  * News/Report: «Что произошло → Почему важно → Контекст».
  * Insight: «Что произошло → Почему важно → Как проверить/повторить».
* `Sources[0]` всегда первоисточник.

---

## 6 Контракт ValidateDraftJson

### Назначение

Автоматически проверить черновик на соответствие формальным и редакционным требованиям.

### Выходной JSON

```json
{
  "is_valid": true,
  "reject_reason": "Duplicate | NoPrimarySource | OffTopic | FactRisk | StyleViolation | ComplianceRisk | null",
  "fixes": [
    {
      "field": "string",
      "action": "replace | remove | shorten",
      "value": "string"
    }
  ]
}
```

### Правила

* `is_valid = false` → публикация запрещена без ручного решения.
* `fixes` — только минимальные правки, не меняющие смысл.
* Проверяется:
  * наличие Sources[0];
  * соответствие шаблону;
  * риски фактчекинга и комплаенса;
  * базовые нарушения стиля.

---

## 7 Шаг RenderText

### Назначение

Преобразовать утверждённый Draft в финальный текст сообщения Telegram.

### Правила

* Не изменяет смысл, структуру и источники.
* Не добавляет новую информацию.
* Не содержит служебных полей и JSON-структур.

---

## 8 Провайдеры и роли моделей (MVP)

Распределение ролей:
- **qwen-flash** — ExtractFactsJson, первичный GenerateDraftJson.
- **gpt-4o-mini** — финальная редактура GenerateDraftJson.
- **gpt-4.1-nano** — ValidateDraftJson.

Смена провайдера **не требует изменения контрактов**.

---

## 9 Ограничения и запреты

* Запрещено:
  * возвращать текст вне JSON;
  * смешивать факты и интерпретации на этапе ExtractFactsJson;
  * генерировать Sources, отсутствующие в первоисточнике;
  * обходить ValidateDraftJson.
* Любое расширение контрактов оформляется новым дополнением.

---
